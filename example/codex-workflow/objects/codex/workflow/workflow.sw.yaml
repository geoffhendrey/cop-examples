id: violations-counter
name: Violations counter
description: Counts violations events for k8s workflows
version: 1.0.0
specVersion: '0.8'
events:
  - name: EventReceived
    type: contracts:cloudevent/platform:event.enriched.v1 #fully qualified reference to the cloudevent
    kind: consumed
    dataOnly: true #only the data portion of the event will be passed to this workflow
    source: platform
  - name: CreateMeasurement
    type: contracts:cloudevent/platform:measurement.received.v1
    kind: produced
functions:
  - name: checkType
    type: expression
    operation: >
      type = 'alerting:healthrule.violation' and 'k8s:workflow' in entities.type
  - name: createMeasurement
    type: expression
    operation: >
        {
          "entity": $.entities[0],
          "type": "codex_workflow:healthrule.violation.count",
          "attributes": {
            "violation_severity": $.attributes.violation_severity
          },
          "measurements": [
            {
              "timestamp": $.attributes.event_time,
              "intValue": $.attributes.'event_details.condition_details.violation_count'
            }
          ]
        }
states:
  - name: EventReceived
    type: event
    onEvents:
      - eventRefs:
          - EventReceived
        actions:
          - name: createMeasurement
            condition: ${ fn:checkType }
            functionRef: createMeasurement
            actionDataFilter:
              toStateData: ${ measurement }
    stateDataFilter:
      output: ${ measurement }
    end:
      terminate: true
      produceEvents:
        - eventRef: CreateMeasurement
          data: ${ measurement }