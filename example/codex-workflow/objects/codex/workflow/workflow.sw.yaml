id: violations-counter
name: Violations counter
description: Counts violations events for k8s workflows
version: 1.0.0
specVersion: '0.8'
events:
  - name: EventReceived
    type: contracts:cloudevent/platform:event.enriched.v1 #fully qualified reference to the cloudevent
    kind: consumed
    dataOnly: true #only the data portion of the event will be passed to this workflow
    source: platform
  - name: CreateMeasurement
    type: contracts:cloudevent/platform:measurement.received.v1
    kind: produced
functions:
  - name: checkType
    type: statedFunction
    operation: "${function($in){$in.type = 'alerting:healthrule.violation' and 'k8s:workflow' in $in.entities.type}}"
  - name: createMeasurement
    type: statedFunction
    operation: >
        ${function($in){
          {
            "entity": $in.entities[0],
            "type": "codex_workflow:healthrule.violation.count",
            "attributes": {
              "violation_severity": $in.attributes.violation_severity
            },
            "measurements": [
              {
                "timestamp": $in.attributes.event_time,
                "intValue": $in.attributes.'event_details.condition_details.violation_count'
              }
            ]
          }
        }}
states:
  - name: EventReceived
    type: event
    onEvents:
      - eventRefs:
          - EventReceived
        actions:
          - name: createMeasurement
            condition: /${ functions[name='checkType'].operation }
            functionRef: /${ functions[name='createMeasurement'].operation }
            actionDataFilter:
              toStateData: ${ function($in){$in.measurement} }
    stateDataFilter:
      output: ${ measurement }
    end:
      terminate: true
      produceEvents:
        - eventRef: CreateMeasurement
          data: ${ measurement }
test:
  in:
    entities:
      - type: k8s:workflow
        id: k8s:deployment:UtS/BYZNO7y7aDUpXqRvHQ
    timestamp: 1706911250000
    type: "alerting:healthrule.violation"
    attributes:
      violation_severity: CRITICAL
      event_details.condition_details.violation_count: 2
      event_time: 1706911260000
      violation_id: 88JOkQyNP22VbCNaZJoGkA
      violation_duration: 6900000
      config_name: K8s Deployment Running vs Desired
      event_id: xET0tH4lPP6GxkgpN5m8DQ
      event_details.condition_details.metric_source: sys:derived:infra-agent
      entity_type: k8s:deployment
      event_type: "Violation Continues: Critical"
      violation_status: OPEN
      violation_start_time: 1706904360000
  cases:
    testConditionIsFunction: >
          /${$type(states[name='EventReceived'].onEvents.actions[name='createMeasurement'].condition)='function'
              ?'pass'
              :'fail (not a function)'}
    testConditionTriggers: >
      /${(
               $action := states[name='EventReceived'].onEvents.actions[name='createMeasurement'];
               $action.condition($$.test.in)?'pass':  'fail (action condition did not trigger on smoke test data)'
       )}
    testMeasurementIsProduces: >
       /${(
                $action := states[name='EventReceived'].onEvents.actions[name='createMeasurement'];
                $action.functionRef($$.test.in).measurements[0].timestamp = test.in.attributes.event_time?'pass':'fail (timestamp)'
        )}
    
